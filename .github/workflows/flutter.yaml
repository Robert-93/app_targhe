name: Flutter CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.4'
      - name: Inject Firebase config from Secrets
        env:
          FIREBASE_ANDROID_JSON: ${{ secrets.FIREBASE_ANDROID_JSON }}
          FIREBASE_IOS_PLIST: ${{ secrets.FIREBASE_IOS_PLIST }}
        run: |
          set -e
          if [ -n "$FIREBASE_ANDROID_JSON" ]; then
            mkdir -p android/app
            printf '%s' "$FIREBASE_ANDROID_JSON" > android/app/google-services.json
            echo "Wrote android/app/google-services.json from secret"
          else
            echo "No FIREBASE_ANDROID_JSON secret found"
          fi
          if [ -n "$FIREBASE_IOS_PLIST" ]; then
            mkdir -p ios/Runner
            printf '%s' "$FIREBASE_IOS_PLIST" > ios/Runner/GoogleService-Info.plist
            echo "Wrote ios/Runner/GoogleService-Info.plist from secret"
          else
            echo "No FIREBASE_IOS_PLIST secret found"
          fi
      - name: Debug Flutter
        run: |
          set -x
          flutter --version
          which flutter || where flutter || echo "flutter not found"
          dart --version || echo "dart not found"
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Install dependencies (with retry, verbose logging, and guaranteed upload)
        id: install
        continue-on-error: true
        run: |
          set -x
          mkdir -p ci-logs
          rc=0
          retry() {
            local n=0
            local max=3
            until [ $n -ge $max ]; do
              flutter pub get --verbose 2>&1 | tee -a ci-logs/pub_get.log
              rc=$?
              if [ $rc -eq 0 ]; then
                return 0
              fi
              n=$((n+1))
              echo "flutter pub get failed; retry #$n" | tee -a ci-logs/pub_get.log
              sleep $((n * 5))
            done
            return $rc
          }
          retry || rc=$?
          echo $rc > ci-logs/pub_get_rc
          # ensure step exits successfully so upload runs
          exit 0
      - name: Upload pub_get log
        uses: actions/upload-artifact@v4
        with:
          name: pub_get_log
          path: ci-logs/
      - name: Show pub_get tail (for diagnostics)
        run: |
          echo "---- last 200 lines of pub_get log ----"
          if [ -f ci-logs/pub_get.log ]; then
            tail -n 200 ci-logs/pub_get.log || true
          else
            echo "pub_get.log not found"
          fi
      - name: Fail if pub_get failed
        run: |
          if [ -f ci-logs/pub_get_rc ]; then
            rc=$(cat ci-logs/pub_get_rc)
            if [ "$rc" != "0" ]; then
              echo "flutter pub get failed with exit code $rc"
              exit $rc
            fi
          fi
      - name: Analyze (capture and upload)
        id: analyze
        continue-on-error: true
        run: |
          set -x
          mkdir -p ci-logs
          flutter analyze 2>&1 | tee ci-logs/analyze.log
          echo $? > ci-logs/analyze_rc
      - name: Upload analyze log
        uses: actions/upload-artifact@v4
        with:
          name: analyze_log
          path: ci-logs/
      - name: Show analyze tail (for diagnostics)
        run: |
          echo "---- last 200 lines of analyze log ----"
          if [ -f ci-logs/analyze.log ]; then
            tail -n 200 ci-logs/analyze.log || true
          else
            echo "analyze.log not found"
          fi
      - name: Fail if analyze failed
        run: |
          if [ -f ci-logs/analyze_rc ]; then
            rc=$(cat ci-logs/analyze_rc)
            if [ "$rc" != "0" ]; then
              echo "flutter analyze failed with exit code $rc"
              exit $rc
            fi
          fi
      - name: Run tests (capture and upload)
        id: tests
        continue-on-error: true
        run: |
          set -x
          mkdir -p ci-logs
          mkdir -p /tmp/flutter_test_temp
          export TEMP=/tmp/flutter_test_temp
          export TMP=/tmp/flutter_test_temp
          flutter test -r expanded 2>&1 | tee ci-logs/tests.log
          echo $? > ci-logs/tests_rc
      - name: Upload test log
        uses: actions/upload-artifact@v4
        with:
          name: test_log
          path: ci-logs/
      - name: Show test tail (for diagnostics)
        run: |
          echo "---- last 200 lines of test log ----"
          if [ -f ci-logs/tests.log ]; then
            tail -n 200 ci-logs/tests.log || true
          else
            echo "tests.log not found"
          fi
      - name: Fail if tests failed
        run: |
          if [ -f ci-logs/tests_rc ]; then
            rc=$(cat ci-logs/tests_rc)
            if [ "$rc" != "0" ]; then
              echo "flutter test failed with exit code $rc"
              exit $rc
            fi
          fi

  e2e:
    needs: analyze-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install firebase-tools
        run: npm install -g firebase-tools
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.4'
      - name: Inject Firebase config from Secrets
        env:
          FIREBASE_ANDROID_JSON: ${{ secrets.FIREBASE_ANDROID_JSON }}
        run: |
          set -e
          if [ -n "$FIREBASE_ANDROID_JSON" ]; then
            mkdir -p android/app
            printf '%s' "$FIREBASE_ANDROID_JSON" > android/app/google-services.json
            echo "Wrote android/app/google-services.json"
          else
            echo "No FIREBASE_ANDROID_JSON secret found"
          fi
      - name: Start Firestore emulator
        run: |
          set -e
          mkdir -p ci-logs
          nohup firebase emulators:start --only firestore --project targometro > ci-logs/emulator.log 2>&1 &
          echo $! > ci-logs/emulator.pid
          for i in {1..60}; do
            if grep -q "All emulators ready" ci-logs/emulator.log; then
              echo "Emulator ready"
              break
            fi
            sleep 1
          done
          if ! grep -q "All emulators ready" ci-logs/emulator.log; then
            tail -n 200 ci-logs/emulator.log || true
            exit 1
          fi
      - name: Run E2E test
        run: |
          set -x
          mkdir -p ci-logs
          flutter test integration_test/e2e_sync_test.dart -r expanded 2>&1 | tee ci-logs/e2e_test.log
          echo $? > ci-logs/e2e_rc
      - name: Upload e2e logs
        uses: actions/upload-artifact@v4
        with:
          name: e2e_logs
          path: ci-logs/
      - name: Stop emulator
        if: always()
        run: |
          if [ -f ci-logs/emulator.pid ]; then kill $(cat ci-logs/emulator.pid) || true; fi
      - name: Fail if e2e failed
        run: |
          if [ -f ci-logs/e2e_rc ]; then
            rc=$(cat ci-logs/e2e_rc)
            if [ "$rc" != "0" ]; then
              echo "E2E failed with exit code $rc"
              exit $rc
            fi
          fi
