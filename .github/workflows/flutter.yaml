name: Flutter CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  analyze-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.4'
      - name: Inject Firebase config from Secrets
        env:
          FIREBASE_ANDROID_JSON: ${{ secrets.FIREBASE_ANDROID_JSON }}
          FIREBASE_IOS_PLIST: ${{ secrets.FIREBASE_IOS_PLIST }}
        run: |
          set -e
          if [ -n "$FIREBASE_ANDROID_JSON" ]; then
            mkdir -p android/app
            printf '%s' "$FIREBASE_ANDROID_JSON" > android/app/google-services.json
            echo "Wrote android/app/google-services.json from secret"
          else
            echo "No FIREBASE_ANDROID_JSON secret found"
          fi
          if [ -n "$FIREBASE_IOS_PLIST" ]; then
            mkdir -p ios/Runner
            printf '%s' "$FIREBASE_IOS_PLIST" > ios/Runner/GoogleService-Info.plist
            echo "Wrote ios/Runner/GoogleService-Info.plist from secret"
          else
            echo "No FIREBASE_IOS_PLIST secret found"
          fi
      - name: Debug Flutter
        run: |
          set -x
          flutter --version
          which flutter || where flutter || echo "flutter not found"
          dart --version || echo "dart not found"
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Install dependencies (with retry)
        run: |
          set -e
          retry() {
            local n=0
            local max=3
            until [ $n -ge $max ]; do
              if flutter pub get; then
                return 0
              fi
              n=$((n+1))
              echo "flutter pub get failed; retry #$n"
              sleep $((n * 5))
            done
            return 1
          }
          retry
      - name: Analyze
        run: flutter analyze
      - name: Run tests
        run: |
          mkdir -p /tmp/flutter_test_temp
          export TEMP=/tmp/flutter_test_temp
          export TMP=/tmp/flutter_test_temp
          flutter test -r expanded
